<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>File manager</title>
	<script src="/jquery-3.3.1.min.js"></script>
    <script src="./Main_action.js"></script>
    <script src="./Group_action.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css"> <!-- https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css -->
    <link rel="stylesheet" href="css/style.css"> <!-- Resource style -->
    <title>File Manager</title>
</head>
<body>
	<button type='button' id='Dload'>Download</button><br>
	<button type='button' id='Bpage'>Go up one directory</button><br>
	<button type='button' id='Nfolder'>New Folder</button><br>
	<button type='button' id='GroupManage'>Group Management</button><br>
    <ul id='file_list'>
        <li>it should be different based on who the user is</li>
    </ul>

    <!-- 上传文件可以改为单独跳转html进行上传 -->
	<form>
        <p>文件: <input id="file" name="file" type="file" /></p>
        <p><button id="Uload" type="button">上传</button></p>
    </form>
    <div class="dropdown">
        <button onclick="myFunction()" class="dropbtn">Menu</button>
          <div id="myDropdown" class="dropdown-content">
            <a href="/registraion.html">Log out</a>
            <a href="#0" onclick="upload()">Upload your file</a>
            <a href="/Main_page.html"">Refresh</a>
            <a href="#Paste" onclick="Copyfile()">Paste</a>
          </div>
    </div>
</body>

<!--Display the files-->
<script>
    refresh_token();
	var token = localStorage.token;
	var path = localStorage.path;
	var auth = new URLSearchParams();
	var params = new URLSearchParams();
    var formData = new FormData();
    auth.append("token", token);
    params.append("func", "ls");
    params.append("path", path);
    formData.append("auth", auth);
    formData.append("params", params);

    // Request for contents
    $.ajax({
        async: false,
        url: "./cgi-bin/serve.py", 
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            var json = JSON.parse(response);
            var files = JSON.parse(json.list);
            if(json.errno==1){
                // Todo: Jump to Registraion
                alert("An error occurs! Please login again!");
                window.location.href = "/registraion.html";
            }
            else {
                Display_the_files(files);
            }                              
        },
        error: function (xhr) {
            alert(xhr.status + " " + xhr.statusText + "\n"
                + xhr.responseText);
        }
    });

    while(true){
        setTimeout(refresh_token(),60);
    }
</script>

<!--The Buttons-->
<script>
	$("#Dload").click(function(){
		Download();
	});
	$("#Uload").click(function(){
		upload($("#file"),$("#proc"));
	});
	$("#Bpage").click(function(){
        localStorage.path = localStorage.path.substring(0, localStorage.path.lastIndexOf('/'));
        window.location.href = window.location.href;
	});
	$("#Nfolder").click(function(){
        var dir_name = ""
        $(function() {
            dir_name = prompt("Please enter the directory name:")
            if (!dir_name)
                return;
        })
		Makedir(localStorage.path, dir_name);
	});
	$("#GroupManage").click(function(){
		window.location.href="./Group_page.html";
	});
</script>

</html>