<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Group manager</title>
	<script src="/jquery-3.3.1.min.js"></script>
    <script src="./Main_action.js"></script>
    <script src="./Group_action.js"></script>
    <link rel="stylesheet" href="css/group.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    
    <div class="logbody2">
        <img src="./groups.jpg" width="400" height="400" align="top"> 
    </div>
    <div class="container">
        <div class="leftbox">
            <ul id='group_list'>group name here</ul>
            <h2 style="color:rgb(23, 80, 138);">The Groups you in:</h2>
            <div id="GroupInfo">
                Groupname: <input type="text" id="info_groupname"><br><br>
                <button id="GInfo" class="logbtn">Show the members of this group</button>
            </div>
            
            
            <h2 style="color:rgb(23, 80, 138);">Build a new one</h2>
            <div id="BuildGroupInput">
                Groupname: <input type="text" id="groupname"><br><br>
                <button id="Gbuild" class="logbtn">Build this group</button>
            </div>
            <br>
            <br>
            <br>
        </div>
        <div class="rightbox">
            <ul id='member_list'>Members of this group here</ul>
            <h2 style="color:rgb(23, 80, 138);">Pull someone into your group</h2>
            <div id="PullGroupInput">
                Groupname: <input type="text" id="pull_groupname"><br>
                Username : <input type="text" id="pull_username"><br>
                <button id="GPull" class="logbtn">Pull</button>
            </div>
            <h2 style="color:rgb(23, 80, 138);">delete someone in your group</h2>
            <div id="DelGroupInput">
                Groupname: <input type="text" id="del_groupname"><br>
                Username : <input type="text" id="del_username"><br>
                <button id="GDel" class="logbtn">Delete</button>
            </div>
            <br>
            <br>
            <br>
        </div>
    </div>
</body>

<!--Display the groups you are in-->
<script>
	var token = localStorage.token;
	var path = localStorage.path;
	var auth = new URLSearchParams();
	var params = new URLSearchParams();
    var formData = new FormData();
    auth.append("token", token);
    params.append("func", "lsgrps");
    params.append("path", path);
    formData.append("auth", auth);
    formData.append("params", params);

    // Request for contents
    $.ajax({
        async: false,
        url: "./cgi-bin/serve.py", 
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            var json = JSON.parse(response);
            var files = JSON.parse(json.list);// ????
            var i;
            if(json.errno==1){
                // Todo: Jump to Registraion
                alert("An error occurs! Please login again!");
                window.location.href = "/registraion.html";
            }
            else {
                var len = files.length;
                var tbody = document.getElementById("group_list");
                for (i=0; i<len;i++){
                    var para = document.createElement("li");
                    para.innerHTML = files[i].group + " " + files[i].is_own;
                    tbody.appendChild(para);
                }
            }                              
        },
        error: function (xhr) {
            alert(xhr.status + " " + xhr.statusText + "\n"
                + xhr.responseText);
        }
    });
</script>

<!--The Buttons-->
<script>
    $("#GInfo").click(function(){
        var group_name = $("#info_groupname").val();
        var token = localStorage.token;
	    var auth = new URLSearchParams();
	    var params = new URLSearchParams();
        var formData = new FormData();
        auth.append("token", token);
        params.append("func", "lsmbr");
        params.append("group", group_name);
        formData.append("auth", auth);
        formData.append("params", params);

    // Request for contents
        $.ajax({
            async: false,
            url: "./cgi-bin/serve.py", 
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                var json = JSON.parse(response);
                var files = JSON.parse(json.list);// ????
                var i;
                if(json.errno==1){
                    // Todo: Jump to Registraion
                    alert("An error occurs! Please login again!");
                    window.location.href = "/registraion.html";
                }
                else {
                    var len = files.length;
                    var tbody2 = document.getElementById("member_list");
                    while(tbody2.hasChildNodes()) {
                        tbody2.removeChild(tbody2.firstChild());
                    }
                    for (i=0; i<len;i++){
                        var para = document.createElement("li");
                        para.innerHTML = files[i].user + " " + files[i].is_own;
                        tbody2.appendChild(para);
                    }
                }                              
            },
            error: function (xhr) {
                alert(xhr.status + " " + xhr.statusText + "\n"
                    + xhr.responseText);
            }
        });
	});
    $("#GPull").click(function(){
        var group_name = $("#pull_groupname").val();
        var name = $("#pull_username").val();
        var token = localStorage.token;
	    var auth = new URLSearchParams();
	    var params = new URLSearchParams();
        var formData = new FormData();
        auth.append("token", token);
        params.append("func", "newmbr");
        params.append("group", group_name);
        params.append("user2", name);
        formData.append("auth", auth);
        formData.append("params", params);

    // Request for contents
        $.ajax({
            async: false,
            url: "./cgi-bin/serve.py", 
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert("Success!");                            
            },
            error: function (xhr) {
                alert(xhr.status + " " + xhr.statusText + "\n"
                    + xhr.responseText);
            }
        });
	});
    $("#GDel").click(function(){
        var group_name = $("#del_groupname").val();
        var name = $("#del_username").val();
        var token = localStorage.token;
	    
	    var auth = new URLSearchParams();
	    var params = new URLSearchParams();
        var formData = new FormData();
        auth.append("token", token);
        params.append("func", "delmbr");
        params.append("group", group_name);
        params.append("user2", name);
        formData.append("auth", auth);
        formData.append("params", params);

    // Request for contents
        $.ajax({
            async: false,
            url: "./cgi-bin/serve.py", 
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert("Success!");                         
            },
            error: function (xhr) {
                alert(xhr.status + " " + xhr.statusText + "\n"
                    + xhr.responseText);
            }
        });
	});
	$("#Gbuild").click(function(){
        var name = $("#groupname").val();
        var token = localStorage.token;
        var auth = new URLSearchParams();
        var params = new URLSearchParams();
        var formData = new FormData();
        auth.append("token", token);
        params.append("func", "newgrp");
        params.append("group", name);
        formData.append("auth", auth);
        formData.append("params", params);

        // Request for contents
        $.ajax({
            async: false,
            url: "./cgi-bin/serve.py", 
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert("success!")                             
            },
            error: function (xhr) {
                alert(xhr.status + " " + xhr.statusText + "\n"
                    + xhr.responseText);
            }
        });
	});
</script>
</html>