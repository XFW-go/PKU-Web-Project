<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>File manager</title>
	<script src="/jquery-3.3.1.min.js"></script>
    <script src="./Main_action.js"></script>
    <script src="./Group_action.js"></script>
<style>
    body {background-color: powderblue;}
</style>
</head>
<body>
    <img src="./groups.jpg" width="400" height="400">
    <h2 style="color:rgb(23, 80, 138);">The Groups you are already in:</h2>
    <ul id='group_list'>
        <li>it should be different based on who the user is</li>
    </ul>
    <div id="GroupInfo">
        Groupname: <input type="text" id="info_groupname"><br>
        <button id="GInfo" style="color:green">Show the members of this group</button>
    </div>
    <ul id='member_list'>
        <li>it should be different based on who the group is</li>
    </ul>
    <h2 style="color:rgb(23, 80, 138);">Build a new one</h2>
    <div id="BuildGroupInput">
        Groupname: <input type="text" id="groupname"><br>
        <button id="Gbuild" style="color:green">Build this group</button>
    </div>
    <h2 style="color:rgb(23, 80, 138);">Pull someone into your group</h2>
    <div id="PullGroupInput">
        Groupname: <input type="text" id="pull_groupname"><br>
        Username : <input type="text" id="pull_username"><br>
        <button id="GPull">Pull</button>
    </div>
    <h2 style="color:rgb(23, 80, 138);">delete someone in your group</h2>
    <div id="DelGroupInput">
        Groupname: <input type="text" id="del_groupname"><br>
        Username : <input type="text" id="del_username"><br>
        <button id="GDel">Delete</button>
    </div>
</body>

<!--Display the groups you are in-->
<script>
	var token = localStorage.token;
	var path = localStorage.path;
	var auth = new URLSearchParams();
	var params = new URLSearchParams();
    var formData = new FormData();
    auth.append("token", token);
    params.append("func", "lsgrps");
    params.append("path", path);
    formData.append("auth", auth);
    formData.append("params", params);

    // Request for contents
    $.ajax({
        async: false,
        url: "./cgi-bin/serve.py", 
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            var json = JSON.parse(response);
            var files = JSON.parse(json.list);// ????
            var i;
            if(json.errno==1){
                // Todo: Jump to Registraion
                alert("An error occurs! Please login again!");
                window.location.href = "/registraion.html";
            }
            else {
                var len = files.length;
                var tbody = document.getElementById("group_list");
                for (i=0; i<len;i++){
                    var trow = files[i].group + " "+ files[i].is_own;
                    tbody.appendChild(trow);
                }
            }                              
        },
        error: function (xhr) {
            alert(xhr.status + " " + xhr.statusText + "\n"
                + xhr.responseText);
        }
    });
</script>

<!--The Buttons-->
<script>
    $("#GInfo").click(function(){
        var group_name = $("#info_groupname").val();
        var token = localStorage.token;
	    var auth = new URLSearchParams();
	    var params = new URLSearchParams();
        var formData = new FormData();
        auth.append("token", token);
        params.append("func", "lsmbr");
        params.append("group", group_name);
        formData.append("auth", auth);
        formData.append("params", params);

    // Request for contents
        $.ajax({
            async: false,
            url: "./cgi-bin/serve.py", 
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                var json = JSON.parse(response);
                var files = JSON.parse(json.list);// ????
                var i;
                if(json.errno==1){
                    // Todo: Jump to Registraion
                    alert("An error occurs! Please login again!");
                    window.location.href = "/registraion.html";
                }
                else {
                    var len = files.length;
                    var tbody2 = document.getElementById("member_list");
                    for (i=0; i<len;i++){
                        var trow2 = files[i].user;
                        tbody2.appendChild(trow2);
                    }
                }                              
            },
            error: function (xhr) {
                alert(xhr.status + " " + xhr.statusText + "\n"
                    + xhr.responseText);
            }
        });
	});
    $("#GPull").click(function(){
        var group_name = $("#pull_groupname").val();
        var name = $("#pull_username").val();
        var token = localStorage.token;
	    var auth = new URLSearchParams();
	    var params = new URLSearchParams();
        var formData = new FormData();
        auth.append("token", token);
        params.append("func", "newmbr");
        params.append("group", group_name);
        params.append("user2", name);
        formData.append("auth", auth);
        formData.append("params", params);

    // Request for contents
        $.ajax({
            async: false,
            url: "./cgi-bin/serve.py", 
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert("Success!");                            
            },
            error: function (xhr) {
                alert(xhr.status + " " + xhr.statusText + "\n"
                    + xhr.responseText);
            }
        });
	});
    $("#GDel").click(function(){
        var group_name = $("#del_groupname").val();
        var name = $("#del_username").val();
        var token = localStorage.token;
	    
	    var auth = new URLSearchParams();
	    var params = new URLSearchParams();
        var formData = new FormData();
        auth.append("token", token);
        params.append("func", "delmbr");
        params.append("group", group_name);
        params.append("user2", name);
        formData.append("auth", auth);
        formData.append("params", params);

    // Request for contents
        $.ajax({
            async: false,
            url: "./cgi-bin/serve.py", 
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert("Success!");                         
            },
            error: function (xhr) {
                alert(xhr.status + " " + xhr.statusText + "\n"
                    + xhr.responseText);
            }
        });
	});
	$("#Gbuild").click(function(){
        var name = $("#groupname").val();
        var token = localStorage.token;
        var auth = new URLSearchParams();
        var params = new URLSearchParams();
        var formData = new FormData();
        auth.append("token", token);
        params.append("func", "newgrp");
        params.append("group", name);
        formData.append("auth", auth);
        formData.append("params", params);

        // Request for contents
        $.ajax({
            async: false,
            url: "./cgi-bin/serve.py", 
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert("success!")                             
            },
            error: function (xhr) {
                alert(xhr.status + " " + xhr.statusText + "\n"
                    + xhr.responseText);
            }
        });
	});
</script>
</html>