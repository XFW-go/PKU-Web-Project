<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="/jquery-3.3.1.min.js"></script>
    <script src="/spark-md5.min.js"></script>
    <title>upload</title>
</head>

<body>
    <form>
        <p>文件: <input id="file" name="file" type="file" /></p>
        <p><button id="subbut" type="button">上传</button></p>
        <p id="proc"></p>
    </form>
</body>

<script>
    $("#subbut").click(function () {
        var token; // TODO:
        var path; // TODO:
        var file = $("#file")[0].files[0];
        var filename = file.name;
        var size = file.size;

        var need_upload = true;

        var chuck = 1000000;
        var nchunk = Math.ceil(size / chuck);

        var md5list = new Array(nchunk);
        var ajaxlist = new Array(nchunk);

        var spark = new SparkMD5.ArrayBuffer();
        var reader = new FileReader();
        reader.onload = function (event) {
            spark.append(event.target.result);
        };

        for (var i = 0; i < nchunk; i++) {
            var beg = i * chuck;
            var end = beg + chuck;
            if (end > size)
                end = size
            reader.readAsArrayBuffer(file.slice(start, end));
        }

        var md5 = spark.end(); // TODO: md5 calc

        var formData = new FormData();
        var auth = new URLSearchParams();
        auth.append("token", token);
        var params = new URLSearchParams();
        params.append("func", "diff");
        params.append("filename", filename);
        params.append("path", path);
        params.append("md5", md5);
        formData.append("auth", auth);
        formData.append("params", params);
        $.ajax({
            async: false,
            url: "/cgi-bin/serve.py",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                var json = JSON.parse(response)
                need_upload = !json.exist;
            },
            error: function (xhr) {
                alert(xhr.status + " " + xhr.statusText + "\n"
                    + xhr.responseText);
                // TODO: filename duplicate will give stat=400 error
            }
        });

        if (need_upload) {
            var proc = 0;
            $("#proc")[0].innerHTML = "process: " + proc.toFixed(0) + "%";

            for (var i = 0; i < nchunk; i++) {
                var beg = i * chuck;
                var end = beg + chuck;
                if (end > size)
                    end = size
                var slice = file.slice(beg, end);

                var formData = new FormData();
                var params = new URLSearchParams();
                params.append("func", "upload");
                params.append("no", i);
                formData.append("auth", auth);
                formData.append("params", params);
                formData.append("file", slice);

                ajaxlist[i] = $.ajax({
                    url: "/cgi-bin/serve.py",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        var json = JSON.parse(response)
                        md5list[json.no] = json.md5;
                        proc += 100 / nchunk;
                        $("#proc")[0].innerHTML = "process: " + proc.toFixed(0) + "%";
                    }
                    // TODO: error handler, but error should not occur
                });
            }
        }
        else {
            ajaxlist = new Array(1);
            var dfd = $.Deferred();
            dfd.resolve();
            ajaxlist[0] = dfd.promise();
        }

        $.when.apply(null, ajaxlist).done(function () {
            var md5list_str = "";
            if (need_upload) {
                md5list_str = md5list.join('","');
                md5list_str = '["' + md5list_str + '"]';
            }
            else {
                md5list_str = "[]";
            }

            var formData = new FormData();
            var params = new URLSearchParams();
            params.append("func", "commit");
            params.append("filename", filename);
            params.append("path", path);
            params.append("size", size);
            params.append("md5list", md5list_str);
            params.append("filemd5", md5);
            formData.append("auth", auth);
            formData.append("params", params);
            $.ajax({
                async: false,
                url: "/cgi-bin/serve.py",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    // TODO: upload complete
                    // alert(response);
                },
                // TODO: error handler, but error should not occur
            });
        });
    });
</script>

</html>